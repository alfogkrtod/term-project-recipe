# 🍳 레시피 검색 시스템 아키텍처 문서

## 1. 시스템 개요도

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              🖥️ CLIENT (Browser)                                │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                         index.php (메인 페이지)                          │    │
│  │  ┌─────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐  │    │
│  │  │ 검색 입력창  │  │ 선택된 재료 태그 │  │ 레시피 목록 / 상세 보기     │  │    │
│  │  └─────────────┘  └─────────────────┘  └─────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                      │                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    public/assets/js/script.js                           │    │
│  │         (이벤트 처리, API 호출, DOM 조작, 페이지네이션)                   │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                      │                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    public/assets/css/style.css                          │    │
│  │                    (글래스모피즘 UI 스타일링)                             │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       │ HTTP Request (AJAX/Fetch)
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              🔧 SERVER (PHP)                                    │
│                                                                                 │
│  ┌──────────────────────────────── API Layer ───────────────────────────────┐   │
│  │                                                                          │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐   │   │
│  │  │ autocomplete.php│  │   search.php    │  │      recipe.php         │   │   │
│  │  │ (자동완성 API)   │  │ (로컬 DB 검색)  │  │   (상세 정보 조회)       │   │   │
│  │  └────────┬────────┘  └────────┬────────┘  └───────────┬─────────────┘   │   │
│  │           │                    │                       │                 │   │
│  │  ┌────────┴────────────────────┴───────────────────────┴─────────────┐   │   │
│  │  │                     recipes_proxy.php                             │   │   │
│  │  │                   (외부 API 프록시 서버)                           │   │   │
│  │  └───────────────────────────────┬───────────────────────────────────┘   │   │
│  └──────────────────────────────────┼───────────────────────────────────────┘   │
│                                     │                                           │
│  ┌─────────────────────────── Business Logic ───────────────────────────────┐   │
│  │                                                                          │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐     │   │
│  │  │                   includes/functions.php                        │     │   │
│  │  │  • parseIngredients()    - 재료명 파싱                          │     │   │
│  │  │  • getAllIngredients()   - 전체 재료 목록 조회                   │     │   │
│  │  │  • searchAutocomplete()  - 자동완성 검색                        │     │   │
│  │  │  • searchRecipesByIngredients() - 레시피 검색 (AND 조건)        │     │   │
│  │  │  • getRecipeDetail()     - 레시피 상세 조회                      │     │   │
│  │  │  • sendJsonResponse()    - JSON 응답 출력                       │     │   │
│  │  └─────────────────────────────────────────────────────────────────┘     │   │
│  │                                     │                                    │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐     │   │
│  │  │                   includes/krayhangeul.php                      │     │   │
│  │  │  • CrayHangulClass                                              │     │   │
│  │  │    - split_han()   : 한글 한 글자 → 자소 배열 분리              │     │   │
│  │  │    - join_han()    : 자소 배열 → 한글 한 글자 조합              │     │   │
│  │  │    - hangulPuli()  : 문자열 전체 자소 분리                       │     │   │
│  │  └─────────────────────────────────────────────────────────────────┘     │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                     │                                           │
│  ┌─────────────────────────── Configuration ────────────────────────────────┐   │
│  │  ┌─────────────────────┐       ┌─────────────────────────────────────┐   │   │
│  │  │   config/db.php     │       │     config/external_api.php         │   │   │
│  │  │  • DB 연결 설정      │       │  • 외부 API 키/URL 설정              │   │   │
│  │  │  • getDBConnection()│       │  • EXTERNAL_API_KEY                 │   │   │
│  │  └─────────────────────┘       └─────────────────────────────────────┘   │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                     │                                           │
│  ┌─────────────────────────── View Templates ───────────────────────────────┐   │
│  │  ┌─────────────────────┐       ┌─────────────────────────────────────┐   │   │
│  │  │ templates/header.php│       │      templates/footer.php           │   │   │
│  │  │  • HTML 헤드        │       │  • 푸터                              │   │   │
│  │  │  • 네비게이션        │       │  • JS 로드                          │   │   │
│  │  └─────────────────────┘       └─────────────────────────────────────┘   │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                        ┌──────────────┴──────────────┐
                        ▼                             ▼
┌───────────────────────────────────┐   ┌─────────────────────────────────────────┐
│        🗄️ MySQL Database          │   │      🌐 External API                     │
│                                   │   │                                         │
│  ┌─────────────────────────────┐  │   │  FoodSafetyKorea COOKRCP01              │
│  │      recipes 테이블          │  │   │  http://openapi.foodsafetykorea.go.kr  │
│  │  • RCP_SEQ (PK)             │  │   │                                         │
│  │  • RCP_NM (레시피명)         │  │   │  요청 형식:                              │
│  │  • RCP_PARTS_DTLS (재료)     │  │   │  /api/{key}/{serviceId}/json/           │
│  │  • ATT_FILE_NO_MAIN (이미지) │  │   │  {start}/{end}/RCP_PARTS_DTLS=...       │
│  │  • MANUAL01~20 (조리법)      │  │   │                                         │
│  │  • MANUAL_IMG01~20          │  │   │  응답: JSON                              │
│  │  • INFO_* (영양정보)         │  │   │  호출 제한: 1000회/일                    │
│  └─────────────────────────────┘  │   └─────────────────────────────────────────┘
└───────────────────────────────────┘
```

---

## 2. 기능 단위 구분

### 2.1 사용자 기능 (User Features)

| 기능 | 설명 | 관련 파일 |
|------|------|-----------|
| 🔍 **재료 검색** | 재료명 입력으로 자동완성 후보 표시 | `script.js`, `autocomplete.php` |
| 🏷️ **재료 선택/해제** | 선택한 재료를 태그로 관리 | `script.js` |
| 📋 **레시피 목록** | 선택된 재료를 포함하는 레시피 카드 표시 | `script.js`, `search.php`, `recipes_proxy.php` |
| 📄 **페이지네이션** | 50개 단위로 레시피 목록 페이지 이동 | `script.js` |
| 📖 **레시피 상세** | 재료, 영양정보, 단계별 조리법 표시 | `script.js`, `recipe.php` |
| ↩️ **목록 복귀** | 상세에서 목록으로 돌아가기 | `script.js` |

### 2.2 시스템 기능 (System Features)

| 기능 | 설명 | 관련 파일 |
|------|------|-----------|
| 🔤 **한글 자소 검색** | 초성/중성/종성 분리로 유연한 검색 | `krayhangeul.php`, `functions.php` |
| 📊 **재료 파싱** | RCP_PARTS_DTLS에서 재료명 추출 | `functions.php` |
| 🔐 **SQL Injection 방지** | PDO Prepared Statement 사용 | `db.php`, `functions.php` |
| 🌐 **외부 API 프록시** | CORS 우회 및 API 키 보호 | `recipes_proxy.php` |
| ⚠️ **에러 처리** | try-catch 기반 예외 처리 | 전체 PHP 파일 |

---

## 3. 모듈 단위 구분

### 3.1 프론트엔드 모듈

```
📦 Frontend Modules
│
├── 🎨 UI Layer (templates/)
│   ├── header.php      → HTML 헤드, 네비게이션, CSS 로드
│   └── footer.php      → 푸터, JavaScript 로드
│
├── 🖌️ Styling (public/assets/css/)
│   └── style.css       → 글래스모피즘 UI, 반응형 레이아웃
│
└── ⚡ Logic (public/assets/js/)
    └── script.js
        ├── 검색 모듈      → handleSearchInput(), searchAutocomplete()
        ├── 재료 관리 모듈  → addIngredient(), removeIngredient()
        ├── 레시피 모듈    → searchRecipes(), displayRecipes()
        ├── 상세보기 모듈  → showRecipeDetail(), displayRecipeDetail()
        ├── 페이지네이션   → displayPagination()
        └── 유틸리티      → escapeHtml(), hideAutocomplete()
```

### 3.2 백엔드 모듈

```
📦 Backend Modules
│
├── 🔌 API Endpoints (api/)
│   ├── autocomplete.php   → GET /api/autocomplete.php?q={query}
│   ├── search.php         → GET /api/search.php?ingredients={list}&page={n}
│   ├── recipe.php         → GET /api/recipe.php?id={rcpSeq}
│   └── recipes_proxy.php  → GET /api/recipes_proxy.php?ingredients={list}&page={n}
│
├── 🧠 Business Logic (includes/)
│   ├── functions.php
│   │   ├── parseIngredients($partsDetails)
│   │   ├── getAllIngredients()
│   │   ├── matchHangul($searchTerm, $target)
│   │   ├── searchAutocomplete($query, $limit)
│   │   ├── searchRecipesByIngredients($ingredients, $page, $perPage)
│   │   ├── getRecipeDetail($rcpSeq)
│   │   └── sendJsonResponse($data, $statusCode)
│   │
│   └── krayhangeul.php
│       └── CrayHangulClass
│           ├── split_han($char, $jong_split)
│           ├── join_han($chars)
│           └── hangulPuli($str, $jong_split)
│
└── ⚙️ Configuration (config/)
    ├── db.php             → PDO 연결, getDBConnection()
    └── external_api.php   → API 키, URL, 페이지당 개수 설정
```

### 3.3 데이터 모듈

```
📦 Data Modules
│
├── 🗄️ Database (sql/)
│   ├── schema.sql                        → 테이블 구조 정의
│   └── recipes_new_no_name_duplicates.sql → 레시피 데이터 (INSERT)
│
└── 📄 Static Data
    └── sample_ingredients.txt            → 샘플 재료 목록
```

---

## 4. 동작 방식 상세

### 4.1 자동완성 검색 플로우

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         자동완성 검색 시퀀스 다이어그램                        │
└──────────────────────────────────────────────────────────────────────────────┘

[사용자]          [script.js]         [autocomplete.php]      [functions.php]        [DB]
   │                   │                      │                     │                  │
   │  키보드 입력      │                      │                     │                  │
   │ ──────────────> │                      │                     │                  │
   │                   │                      │                     │                  │
   │                   │ (1초 타이머 시작)     │                     │                  │
   │                   │ ─────────────────┐   │                     │                  │
   │                   │                  │   │                     │                  │
   │                   │ <────────────────┘   │                     │                  │
   │                   │                      │                     │                  │
   │                   │  GET ?q=검색어       │                     │                  │
   │                   │ ──────────────────> │                     │                  │
   │                   │                      │                     │                  │
   │                   │                      │  searchAutocomplete │                  │
   │                   │                      │ ─────────────────> │                  │
   │                   │                      │                     │                  │
   │                   │                      │                     │ SELECT DISTINCT  │
   │                   │                      │                     │ ───────────────> │
   │                   │                      │                     │                  │
   │                   │                      │                     │ <─────────────── │
   │                   │                      │                     │   재료 데이터     │
   │                   │                      │                     │                  │
   │                   │                      │   한글 자소 매칭     │                  │
   │                   │                      │   (krayhangeul)     │                  │
   │                   │                      │ <───────────────── │                  │
   │                   │                      │    최대 10개        │                  │
   │                   │                      │                     │                  │
   │                   │  JSON 응답           │                     │                  │
   │                   │ <────────────────── │                     │                  │
   │                   │                      │                     │                  │
   │  자동완성 표시    │                      │                     │                  │
   │ <─────────────── │                      │                     │                  │
   │                   │                      │                     │                  │
```

**동작 설명:**
1. 사용자가 검색창에 입력 → `handleSearchInput()` 이벤트 발생
2. 1초 디바운스 타이머 설정 (연속 입력 시 리셋)
3. 1초 후 `searchAutocomplete()` 호출 → API 요청
4. `autocomplete.php`가 `searchAutocomplete()` 함수 호출
5. `getAllIngredients()`로 DB에서 모든 재료 조회
6. `CrayHangulClass.hangulPuli()`로 검색어와 재료를 자소 분리
7. 자소 매칭으로 후보 필터링 (최대 10개)
8. JSON 응답 반환 → UI에 드롭다운 표시

---

### 4.2 레시피 검색 플로우

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                          레시피 검색 시퀀스 다이어그램                         │
└──────────────────────────────────────────────────────────────────────────────┘

[사용자]          [script.js]         [recipes_proxy.php]     [External API]
   │                   │                      │                     │
   │  재료 선택        │                      │                     │
   │ ──────────────> │                      │                     │
   │                   │                      │                     │
   │                   │ addIngredient()      │                     │
   │                   │ searchRecipes()      │                     │
   │                   │                      │                     │
   │                   │  GET ?ingredients=   │                     │
   │                   │      양파,당근&page=1 │                     │
   │                   │ ──────────────────> │                     │
   │                   │                      │                     │
   │                   │                      │  cURL 요청           │
   │                   │                      │  /api/{key}/COOKRCP01│
   │                   │                      │  /json/1/50/         │
   │                   │                      │  RCP_PARTS_DTLS=양파 │
   │                   │                      │ ──────────────────> │
   │                   │                      │                      │
   │                   │                      │ <────────────────── │
   │                   │                      │    JSON 레시피 목록  │
   │                   │                      │                     │
   │                   │  정규화된 JSON       │                     │
   │                   │ <────────────────── │                     │
   │                   │                      │                     │
   │  레시피 카드      │                      │                     │
   │  그리드 표시      │                      │                     │
   │ <─────────────── │                      │                     │
   │                   │                      │                     │
```

**또는 로컬 DB 검색 시:**

```
[사용자]          [script.js]           [search.php]          [functions.php]        [DB]
   │                   │                      │                     │                  │
   │  재료 선택        │                      │                     │                  │
   │ ──────────────> │                      │                     │                  │
   │                   │                      │                     │                  │
   │                   │  GET ?ingredients=   │                     │                  │
   │                   │      양파,당근&page=1 │                     │                  │
   │                   │ ──────────────────> │                     │                  │
   │                   │                      │                     │                  │
   │                   │                      │ searchRecipesByIngredients            │
   │                   │                      │ ─────────────────> │                  │
   │                   │                      │                     │                  │
   │                   │                      │                     │ SELECT * FROM    │
   │                   │                      │                     │ recipes WHERE    │
   │                   │                      │                     │ RCP_PARTS_DTLS   │
   │                   │                      │                     │ LIKE '%양파%'    │
   │                   │                      │                     │ AND LIKE '%당근%'│
   │                   │                      │                     │ ───────────────> │
   │                   │                      │                     │                  │
   │                   │                      │                     │ <─────────────── │
   │                   │                      │ <───────────────── │   레시피 배열     │
   │                   │                      │                     │                  │
   │                   │  JSON 응답           │                     │                  │
   │                   │ <────────────────── │                     │                  │
   │                   │                      │                     │                  │
   │  레시피 그리드    │                      │                     │                  │
   │ <─────────────── │                      │                     │                  │
```

**동작 설명:**
1. 사용자가 자동완성에서 재료 클릭 → `addIngredient()` 호출
2. 선택된 재료 배열에 추가 → 태그 UI 업데이트
3. `searchRecipes()` 호출 → API 요청 (외부 API 또는 로컬 DB)
4. **AND 조건**으로 모든 재료 포함하는 레시피 검색
5. 페이지당 50개 결과 반환
6. `displayRecipes()`로 카드 그리드 렌더링
7. `displayPagination()`으로 페이지 버튼 생성

---

### 4.3 레시피 상세 보기 플로우

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         레시피 상세 시퀀스 다이어그램                          │
└──────────────────────────────────────────────────────────────────────────────┘

[사용자]          [script.js]           [recipe.php]          [functions.php]        [DB]
   │                   │                      │                     │                  │
   │  레시피 카드      │                      │                     │                  │
   │  클릭             │                      │                     │                  │
   │ ──────────────> │                      │                     │                  │
   │                   │                      │                     │                  │
   │                   │ showRecipeDetail()   │                     │                  │
   │                   │                      │                     │                  │
   │                   │  GET ?id={RCP_SEQ}   │                     │                  │
   │                   │ ──────────────────> │                     │                  │
   │                   │                      │                     │                  │
   │                   │                      │  getRecipeDetail()  │                  │
   │                   │                      │ ─────────────────> │                  │
   │                   │                      │                     │                  │
   │                   │                      │                     │ SELECT * FROM    │
   │                   │                      │                     │ recipes WHERE    │
   │                   │                      │                     │ RCP_SEQ = ?      │
   │                   │                      │                     │ ───────────────> │
   │                   │                      │                     │                  │
   │                   │                      │                     │ <─────────────── │
   │                   │                      │ <───────────────── │   레시피 상세     │
   │                   │                      │                     │                  │
   │                   │  JSON 응답           │                     │                  │
   │                   │ <────────────────── │                     │                  │
   │                   │                      │                     │                  │
   │                   │ displayRecipeDetail()│                     │                  │
   │                   │                      │                     │                  │
   │  상세 정보 표시   │                      │                     │                  │
   │  • 레시피명       │                      │                     │                  │
   │  • 완성 이미지    │                      │                     │                  │
   │  • 영양 정보      │                      │                     │                  │
   │  • 재료 목록      │                      │                     │                  │
   │  • 단계별 조리법  │                      │                     │                  │
   │    (MANUAL +IMG)  │                      │                     │                  │
   │ <─────────────── │                      │                     │                  │
```

**동작 설명:**
1. 사용자가 레시피 카드 클릭 → `showRecipeDetail(rcpSeq)` 호출
2. `recipe.php` API로 상세 정보 요청
3. `getRecipeDetail()`로 DB 조회 (PDO Prepared Statement)
4. JSON 응답 반환
5. `displayRecipeDetail()`로 상세 UI 렌더링
   - 레시피명 + 완성 이미지
   - 영양정보 (열량, 탄수화물, 단백질, 지방, 나트륨)
   - 재료 목록
   - MANUAL01~20과 MANUAL_IMG01~20을 짝지어 단계별 표시
6. 목록 섹션 숨김, 상세 섹션 표시

---

### 4.4 한글 자소 검색 알고리즘

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         한글 자소 검색 원리                                   │
└──────────────────────────────────────────────────────────────────────────────┘

입력: "양"
      │
      ▼
┌─────────────────────────────────────┐
│  hangulPuli("양", true)             │
│                                     │
│  유니코드 분해:                      │
│  '양' (U+C591)                      │
│    = 초성(ㅇ) + 중성(ㅑ) + 종성(ㅇ)  │
│                                     │
│  결과: "ㅇㅑㅇ"                      │
└─────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────┐
│  DB의 모든 재료와 비교               │
│                                     │
│  "양파" → hangulPuli → "ㅇㅑㅇㅍㅏ" │
│  "양배추" → "ㅇㅑㅇㅂㅐㅊㅜ"        │
│  "고양이" → "ㄱㅗㅇㅑㅇㅇㅣ"        │
│                                     │
│  strpos("ㅇㅑㅇㅍㅏ", "ㅇㅑㅇ")     │
│    → 0 (매칭! ✓)                    │
│                                     │
│  strpos("ㅇㅑㅇㅂㅐㅊㅜ", "ㅇㅑㅇ") │
│    → 0 (매칭! ✓)                    │
│                                     │
│  strpos("ㄱㅗㅇㅑㅇㅇㅣ", "ㅇㅑㅇ") │
│    → 2 (매칭! ✓)                    │
└─────────────────────────────────────┘
      │
      ▼
결과: ["양파", "양배추", "고양이", ...]
```

**특징:**
- 초성만 입력해도 검색 가능 (예: "ㅇㅍ" → "양파")
- 부분 입력도 매칭 (예: "양" → "양파", "양배추")
- 겹자음/겹모음 지원 (예: "ㄳ" → "ㄱㅅ" 분리)

---

## 5. 데이터 흐름 요약

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              전체 데이터 흐름                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────┐
                    │   사용자    │
                    └──────┬──────┘
                           │
              ┌────────────┼────────────┐
              ▼            ▼            ▼
        ┌──────────┐ ┌──────────┐ ┌──────────┐
        │ 재료입력  │ │ 재료선택  │ │ 카드클릭  │
        └────┬─────┘ └────┬─────┘ └────┬─────┘
             │            │            │
             ▼            ▼            ▼
        ┌──────────┐ ┌──────────┐ ┌──────────┐
        │ 자동완성  │ │ 레시피   │ │ 상세보기  │
        │   API    │ │ 검색 API │ │   API    │
        └────┬─────┘ └────┬─────┘ └────┬─────┘
             │            │            │
             ▼            ▼            ▼
        ┌──────────────────────────────────────┐
        │           functions.php              │
        │    (비즈니스 로직 + 한글 처리)        │
        └─────────────────┬────────────────────┘
                          │
              ┌───────────┴───────────┐
              ▼                       ▼
        ┌──────────┐           ┌──────────────┐
        │  MySQL   │           │ External API │
        │   DB     │           │ (선택사항)    │
        └──────────┘           └──────────────┘
```

---

## 6. API 엔드포인트 정리

| 엔드포인트 | 메서드 | 파라미터 | 응답 |
|------------|--------|----------|------|
| `/api/autocomplete.php` | GET | `q` (검색어) | `{ suggestions: string[] }` |
| `/api/search.php` | GET | `ingredients` (쉼표 구분), `page` | `{ recipes: [], total, page, perPage, totalPages }` |
| `/api/recipe.php` | GET | `id` (RCP_SEQ) | `{ recipe: {...} }` |
| `/api/recipes_proxy.php` | GET | `ingredients`, `page` | `{ recipes: [], total, page, totalPages }` |

---

## 7. 보안 고려사항

| 항목 | 구현 방식 |
|------|-----------|
| **SQL Injection** | PDO Prepared Statement 사용 |
| **XSS** | `escapeHtml()` 함수로 출력 이스케이프 |
| **API 키 보호** | 환경변수 또는 서버사이드 프록시 사용 |
| **에러 노출 방지** | 프로덕션에서 `display_errors` 비활성화 권장 |

---

## 8. 파일 의존성 그래프

```
index.php
├── templates/header.php
│   └── public/assets/css/style.css
├── templates/footer.php
│   └── public/assets/js/script.js
│
api/autocomplete.php
├── includes/functions.php
│   ├── config/db.php
│   └── includes/krayhangeul.php
│
api/search.php
├── includes/functions.php
│
api/recipe.php
├── includes/functions.php
│
api/recipes_proxy.php
├── config/external_api.php
```

---

*문서 작성일: 2025-11-30*
